(function(o,c){if(o.PropFuel&&o.PropFuel.__READY)return;var a=Array.isArray(o.PropFuel)?o.PropFuel:[];o.PropFuel=o.PropFuel||{},o.PropFuel=o.PropFuel||{},o.PropFuel.__READY=!1,o.PropFuel.__Q=a;const e={api_url:"https://web.propfuel.com/web",client_id:null,current_url:o.location.href,current_hash:o.location.hash,poll:!1};PropFuel.identify=function(r={}){if(!e.client_id)return e.debug&&console.error("PropFuel: Client ID is required. Please call PropFuel.init() first."),Promise.reject(new Error("PropFuel not initialized"));const i={authentication:r,pf_session:PropFuel.getCookieByName("pf_session")},t=e.api_url+"/"+e.client_id+"/identify";return fetch(t,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(i)}).then(n=>{if(!n.ok)throw e.debug&&console.error("[PropFuel] HTTP error! Status:",n.status),new Error("HTTP error! Status: "+n.status);return n.json()}).then(n=>(n.session_id&&!e.no_cookies&&(c.cookie="pf_session="+n.session_id+"; path=/; domain="+e.current_domain),e.authentication=r,e.debug&&console.log("[PropFuel] User identified:",n),n)).catch(n=>{throw e.debug&&console.error("[PropFuel] Identify error:",n),n})},PropFuel.init=function(r,i={}){if(!r){e.debug&&console.error("PropFuel: Client ID is required");return}if(PropFuel.__INITIALISED){e.debug&&console.warn("PropFuel.init called twice â€“ ignoring");return}PropFuel.__INITIALISED=!0,e.client_id=r,e.current_domain=PropFuel.getDomainForCookie(o.location.hostname),Object.assign(e,i),this.onPageLoad(),o.addEventListener("hashchange",function(){PropFuel.onPageChange()}),o.addEventListener("popstate",function(){PropFuel.onPageChange()}),o.addEventListener("propfuel:pagechange",function(t){t.detail&&t.detail.to!=e.current_url&&(e.current_url=t.detail.to,PropFuel.onPageLoad())}),o.addEventListener("resize",function(){PropFuel.handleViewportChange()}),e.poll&&o.setInterval(function(){PropFuel.onPageChange()},500),o.addEventListener("message",function(t){!t.data||!t.data.source||t.data.source!=="propfuel"||(e.debug&&console.log("PropFuel: Received message",t.data),PropFuel.processMessage(t.data))})},PropFuel.onPageChange=function(){(e.current_url!==o.location.href||e.current_hash!==o.location.hash)&&(e.current_url=o.location.href,e.current_hash=o.location.hash,PropFuel.onPageLoad())},PropFuel.onPageLoad=function(){if(!e.client_id){e.debug&&console.error("PropFuel: Client ID is required");return}if(e.require_cookie){if(typeof e.require_cookie=="string"){const t=e.require_cookie;PropFuel.getCookieByName(t)||(e.no_cookies=!0)}else if(typeof e.require_cookie=="object"){const t=e.require_cookie.name,n=e.require_cookie.value;PropFuel.getCookieByName(t)!==n&&(e.no_cookies=!0)}}if(e.authentication&&e.authentication.cookie){const t=PropFuel.getCookieByName(e.authentication.cookie);t&&(e.authentication.auth_token=t)}const r={client_id:e.client_id,page_url:e.current_url,page_hash:e.current_hash,page_title:c.title,page_query:o.location.search,authentication:e.authentication,no_cookies:e.no_cookies,pf_session:PropFuel.getCookieByName("pf_session"),client_width:o.innerWidth},i=e.api_url+"/"+e.client_id+"/load";fetch(i,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(r)}).then(t=>!t.ok&&e.debug?(console.error("[PropFuel] HTTP error! Status:",t.status),t.status===404&&console.error("[PropFuel] Invalid client id:",e.client_id),!1):t.json()).then(t=>{t.session_id&&!e.no_cookies&&(c.cookie="pf_session="+t.session_id+"; path=/; domain="+e.current_domain),t.conditions&&(e.checkin_pending=!0,e.checkin_conditions=t.conditions),t.checkin_id?e.active_checkin===t.checkin_id||(e.active_checkin&&e.active_checkin!==t.checkin_id&&e.active_element.remove(),PropFuel.showCheckinIframe(t.checkin_id)):t.action_fire_id?(e.active_element&&e.active_element.remove(),PropFuel.showActionFireIframe(t.action_fire_id)):(e.active_element&&e.active_element.remove(),e.active_checkin=null)}).catch(t=>{e.debug&&console.error("[PropFuel] Fetch error:",t)})},PropFuel.testConditions=function(){const r=e.checkin_conditions;let i=[];return r&&r.length&&r.forEach(t=>{switch(t.type){case"cookie":i.push(PropFuel.testCookie(t))}}),!i.some(t=>t===!1)},PropFuel.testCookie=function(r){try{const i=r.values.cookie[0].operator,t=r.values.cookie[0].param,n=r.values.cookie[0].value,l=PropFuel.getCookieByName(t);return!!(i==="Exists"&&l||i==="Does not exist"&&l===null||i==="="&&l===n||i==="!="&&l!==n||i==="Contains"&&l.includes(n))}catch(i){return e.debug&&console.error("PropFuel: Error testing cookie condition",i),!1}},PropFuel.showCheckinIframe=function(r){if(e.checkin_pending&&!PropFuel.testConditions())return;const i=c.createElement("iframe");i.setAttribute("id","pf-cif-"+r),i.setAttribute("class","pf-web-frame pf-web-checkin-frame"),i.setAttribute("src",e.api_url+"/"+e.client_id+"/checkin/"+r+"?client_width="+o.innerWidth),i.setAttribute("frameborder","0"),i.setAttribute("scrolling","no"),i.setAttribute("allowtransparency","true"),i.setAttribute("style","position: fixed; bottom: -100px; width: 100%; height: 0px;"),c.body.appendChild(i),e.active_checkin=r,e.active_element=i},PropFuel.showActionFireIframe=function(r){const i=c.createElement("iframe");i.setAttribute("id","pf-afi-"+r),i.setAttribute("class","pf-web-frame pf-web-action-frame"),i.setAttribute("src",e.api_url+"/"+e.client_id+"/action_fire/"+r+"?client_width="+o.innerWidth),i.setAttribute("frameborder","0"),i.setAttribute("scrolling","no"),i.setAttribute("allowtransparency","true");const n=o.innerWidth<=768?"calc(100vw - 20px)":"400px";i.setAttribute("style",`position: fixed; bottom: -100px; width: ${n}; height: 0px;`),c.body.appendChild(i),e.active_element=i},PropFuel.processMessage=function(r){switch(r.action){case"preload":case"show":if(e.active_element&&PropFuel.applyStyles(e.active_element,r),r.target){const i=c.querySelector(r.target);i&&i.appendChild(e.active_element)}break;case"inline":e.active_element&&!e.inline&&(PropFuel.assignToTarget(r.target,r.location),e.inline=!0);break;case"hide":e.active_element&&(e.active_element.remove(),e.active_checkin=null,e.active_element=null);break;case"redirect":r.url&&(console.log("Redirecting to",r.url),o.location.href=r.url);break}},PropFuel.applyStyles=function(r,i){Object.assign(r.style,i.style)},PropFuel.assignToTarget=function(r,i){const t=c.querySelector(r);if(t)switch(i){case"before":t.before(e.active_element);break;case"after":t.after(e.active_element);break;case"prepend":t.prepend(e.active_element);break;case"append":t.append(e.active_element);break;case"replace":t.replaceWith(e.active_element);break}},PropFuel.handleViewportChange=function(){const r=e.active_element;if(!r)return;const i=o.innerWidth<=768,t=i?"calc(100vw - 20px)":"400px";r.style.width=t,r.contentWindow&&r.contentWindow.postMessage({action:"viewport_change",width:o.innerWidth,is_mobile:i},"*")},PropFuel.getComputedStyles=function(r){const i=c.querySelector(r);return o.getComputedStyle(i)},PropFuel.getAllCookieNames=function(){return c.cookie.split(";").map(r=>r.split("=")[0].trim())},PropFuel.getCookieByName=function(r){const i=`${r}=`,t=c.cookie.split(";").map(n=>n.trim()).find(n=>n.startsWith(i));return t?decodeURIComponent(t.slice(i.length)):null},PropFuel.getDomainForCookie=function(r){const i=r.split(".");if(i.length>=3){const t=i.slice(-2).join("."),n=i.slice(-3).join(".");if(["co.uk","com.au","org.uk","gov.uk","ac.uk","on.ca","qc.ca","bc.ca","ab.ca","mb.ca","sk.ca","nl.ca","ns.ca","pe.ca","yk.ca","nt.ca","nu.ca","co.nz","org.nz","govt.nz","ac.nz"].includes(t))return n}return i.slice(-2).join(".")},o.PropFuel.__Q&&o.PropFuel.__Q.length&&o.PropFuel.__Q.forEach(function(r){var i=r[0],t=r.slice(1);typeof o.PropFuel[i]=="function"&&o.PropFuel[i].apply(o.PropFuel,t)}),o.PropFuel.__READY=!0,delete o.PropFuel.__Q})(window,document);
